<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üîÜ –ü—Ä–µ–ª–æ–º–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(145deg, #0c0a1a 0%, #1a1440 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .phone-frame {
            width: 100%;
            max-width: 400px;
            background: rgba(20, 15, 40, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 48px;
            padding: 24px 20px;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* ===== –ö–†–£–¢–û–ï –õ–û–ë–ë–ò ===== */
        .lobby {
            animation: fadeIn 0.5s ease;
        }

        .lobby-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 80px;
            margin-bottom: 10px;
            filter: drop-shadow(0 20px 30px rgba(110, 70, 255, 0.5));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .lobby-title {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #a78bfa, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .lobby-subtitle {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        /* –ö–ê–†–¢–û–ß–ö–ê –í–•–û–î–ê */
        .join-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 32px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
        }

        .input-field {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 10px;
            color: #a78bfa;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .input-box {
            width: 100%;
            padding: 18px 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(167, 139, 250, 0.3);
            border-radius: 24px;
            color: white;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }

        .input-box:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
        }

        .code-input {
            font-family: monospace;
            font-size: 1.8rem;
            letter-spacing: 8px;
            text-align: center;
            font-weight: 700;
        }

        .join-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: none;
            border-radius: 40px;
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.3);
        }

        .join-btn:active {
            transform: scale(0.97);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        /* –≠–ö–†–ê–ù –û–ñ–ò–î–ê–ù–ò–Ø */
        .waiting-screen {
            text-align: center;
        }

        .waiting-header {
            background: linear-gradient(145deg, #2a1f5c, #1a1240);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .waiting-code {
            font-size: 3.5rem;
            font-family: monospace;
            font-weight: 900;
            color: #c4b5fd;
            letter-spacing: 10px;
            margin: 15px 0;
            text-shadow: 0 0 30px #8b5cf6;
        }

        .pulse-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .players-list {
            margin-top: 20px;
        }

        .player-badge {
            display: inline-block;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 40px;
            padding: 10px 18px;
            margin: 5px;
            font-size: 1rem;
        }

        /* –≠–ö–†–ê–ù –ó–ê–î–ê–ù–ò–Ø */
        .task-screen {
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 40px;
            padding: 15px 20px;
        }

        .task-counter {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .task-timer {
            font-size: 2rem;
            font-family: monospace;
            font-weight: 900;
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .task-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 32px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .task-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .task-description {
            color: #94a3b8;
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        /* –ö–ù–û–ü–ö–ò –û–¢–í–ï–¢–û–í */
        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 25px 0;
        }

        .option-btn {
            width: 100%;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 28px;
            color: white;
            font-size: 1.2rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .option-btn:active {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
            transform: scale(0.98);
        }

        .option-btn.selected {
            background: rgba(139, 92, 246, 0.3);
            border-color: #8b5cf6;
        }

        .option-prefix {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #a78bfa;
        }

        /* –ü–û–õ–ï –î–õ–Ø –ß–ò–°–õ–û–í–û–ì–û –û–¢–í–ï–¢–ê */
        .number-input {
            width: 100%;
            padding: 20px;
            font-size: 2rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 30px;
            color: white;
            margin: 20px 0;
        }

        .number-input:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        /* –ü–ï–†–ï–í–ï–†–¢–´–®–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï) */
        .flip-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .flip-card {
            aspect-ratio: 1 / 1;
            background: rgba(139, 92, 246, 0.1);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .flip-card.flipped {
            background: linear-gradient(145deg, #8b5cf6, #6366f1);
            border-color: #a78bfa;
            transform: rotateY(180deg);
        }

        .flip-card.matched {
            opacity: 0.4;
            cursor: default;
            pointer-events: none;
            filter: grayscale(0.5);
            transform: scale(0.95);
        }

        .flip-card.matched.flipped {
            background: #4ade80;
        }

        .flip-card .front,
        .flip-card .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-radius: 24px;
        }

        .flip-card .front {
            transform: rotateY(0deg);
        }

        .flip-card .back {
            transform: rotateY(180deg);
        }

        /* –õ–ê–ó–ï–† (canvas) */
        .laser-canvas {
            width: 100%;
            height: 250px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 30px;
            margin: 20px 0;
            touch-action: none;
        }

        /* –ö–ù–û–ü–ö–ê –û–¢–í–ï–¢–ê */
        .submit-btn {
            width: 100%;
            padding: 22px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            border-radius: 40px;
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 15px;
        }

        .submit-btn:active {
            transform: scale(0.97);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* –õ–ò–î–ï–†–ë–û–†–î */
        .leaderboard-screen {
            text-align: center;
        }

        .leaderboard-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 32px;
            padding: 25px;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.2rem;
        }

        .rank-1 { color: gold; }
        .rank-2 { color: silver; }
        .rank-3 { color: #cd7f32; }

        .final-score {
            font-size: 3rem;
            font-weight: 900;
            color: #fbbf24;
            margin: 20px 0;
        }

        .exit-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 20px;
        }

        /* –£–¢–ò–õ–ò–¢–´ */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <!-- –õ–û–ë–ë–ò (–í–•–û–î) -->
        <div id="lobbyScreen" class="lobby">
            <div class="lobby-header">
                <div class="logo">üîÜ</div>
                <div class="lobby-title">–ü—Ä–µ–ª–æ–º–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–∞</div>
                <div class="lobby-subtitle">8 –∑–∞–¥–∞–Ω–∏–π ¬∑ 15 –º–∏–Ω—É—Ç</div>
            </div>

            <div class="join-card">
                <div class="input-field">
                    <label class="input-label">–¢–í–û–Å –ò–ú–Ø</label>
                    <input type="text" id="playerName" class="input-box" placeholder="–ê–ª–∏—Å–∞" maxlength="15">
                </div>

                <div class="input-field">
                    <label class="input-label">–ö–û–î –¢–ï–°–¢–ê</label>
                    <input type="text" id="examCode" class="input-box code-input" placeholder="000000" maxlength="6" inputmode="numeric">
                </div>

                <button class="join-btn" onclick="joinExam()">
                    <i class="fas fa-play"></i> –í–û–ô–¢–ò
                </button>
            </div>

            <div class="text-center" style="color: #64748b; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> –°–ø—Ä–æ—Å–∏ –∫–æ–¥ —É —É—á–∏—Ç–µ–ª—è
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù –û–ñ–ò–î–ê–ù–ò–Ø (–ö–†–£–¢–û–ô) -->
        <div id="waitingScreen" class="waiting-screen hidden">
            <div class="waiting-header">
                <div class="pulse-dot"></div>
                <span style="color: #94a3b8;">–û–ñ–ò–î–ê–ù–ò–ï –°–¢–ê–†–¢–ê</span>
                <div class="waiting-code" id="displayCode">000000</div>
                <div style="font-size: 1rem; color: #cbd5e1;">–¢—ã: <span id="displayName"></span></div>
            </div>

            <div style="margin: 25px 0;">
                <div style="color: #a78bfa; margin-bottom: 15px;">–£–ß–ê–°–¢–ù–ò–ö–ò</div>
                <div id="playersList" class="players-list">
                    <span class="player-badge">üë§ –û–∂–∏–¥–∞–Ω–∏–µ...</span>
                </div>
            </div>

            <div style="color: #64748b; font-size: 0.9rem;">
                <i class="fas fa-users"></i> –í—Å–µ–≥–æ: <span id="playerCount">1</span>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù –ó–ê–î–ê–ù–ò–Ø -->
        <div id="taskScreen" class="task-screen hidden">
            <div class="task-header">
                <div class="task-counter" id="taskCounter">1/8</div>
                <div class="task-timer" id="taskTimer">15:00</div>
            </div>

            <div id="taskContent" class="task-card">
                <!-- –°—é–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–∞–¥–∞–Ω–∏–µ -->
            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitAnswer()">
                –û–¢–í–ï–¢–ò–¢–¨
            </button>

            <button class="submit-btn" id="nextBtn" style="display: none; background: linear-gradient(135deg, #8b5cf6, #6366f1);" onclick="nextTask()">
                –î–ê–õ–¨–®–ï ‚Üí
            </button>
        </div>

        <!-- –≠–ö–†–ê–ù –õ–ò–î–ï–†–ë–û–†–î–ê -->
        <div id="leaderboardScreen" class="leaderboard-screen hidden">
            <div class="task-header">
                <div class="task-counter">üèÜ –§–ò–ù–ò–®</div>
                <div class="task-timer" id="finalTimer">00:00</div>
            </div>

            <div class="leaderboard-card">
                <div class="final-score" id="finalScore">0</div>
                <div id="finalRank" style="font-size: 1.3rem; margin-bottom: 25px;">–¢–≤–æ—ë –º–µ—Å—Ç–æ: -</div>

                <div id="leaderboardList" style="margin: 25px 0;">
                    <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è -->
                </div>

                <button class="join-btn exit-btn" onclick="exitExam()">
                    <i class="fas fa-sign-out-alt"></i> –í–´–ô–¢–ò
                </button>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="physics-data.js"></script>
    <script>
        // ============================================
        // student.js - –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        // ============================================

        let currentExamId = null;
        let playerName = null;
        let currentTaskIndex = 0;
        let playerScore = 0;
        let examStartTime = null;
        let timerInterval = null;
        let flippedCards = [];
        let matchedPairs = 0;
        let selectedOption = null;
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const lobbyScreen = document.getElementById('lobbyScreen');
        const waitingScreen = document.getElementById('waitingScreen');
        const taskScreen = document.getElementById('taskScreen');
        const leaderboardScreen = document.getElementById('leaderboardScreen');
        const submitBtn = document.getElementById('submitBtn');
        const nextBtn = document.getElementById('nextBtn');

        // ===== –í–•–û–î –í –¢–ï–°–¢ =====
        function joinExam() {
            const name = document.getElementById('playerName').value.trim();
            const code = document.getElementById('examCode').value.trim();

            if (!name || name.length < 2) {
                alert('üë§ –í–≤–µ–¥–∏ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 –±—É–∫–≤—ã)');
                return;
            }

            if (!code || code.length !== 6) {
                alert('üî¢ –í–≤–µ–¥–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥');
                return;
            }

            playerName = name;
            currentExamId = `exam_${code}`;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ
            document.getElementById('displayName').textContent = name;
            document.getElementById('displayCode').textContent = code;
            
            lobbyScreen.classList.add('hidden');
            waitingScreen.classList.remove('hidden');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞
            db.ref(`exams/${currentExamId}`).once('value', (snapshot) => {
                const exam = snapshot.val();
                if (!exam) {
                    alert('‚ùå –¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥');
                    lobbyScreen.classList.remove('hidden');
                    waitingScreen.classList.add('hidden');
                    return;
                }

                // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–∞
                const playerData = {
                    name: name,
                    joinedAt: Date.now(),
                    score: 0,
                    progress: 0,
                    currentTask: 1,
                    completedTasks: []
                };

                db.ref(`exams/${currentExamId}/players/${name}`).set(playerData);
                
                // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                listenToExam();
            });
        }

        // ===== –°–õ–£–®–ê–ï–ú –¢–ï–°–¢ =====
        function listenToExam() {
            db.ref(`exams/${currentExamId}`).on('value', (snapshot) => {
                const exam = snapshot.val();
                if (!exam) return;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
                updatePlayersList(exam.players);

                // –ï—Å–ª–∏ —Ç–µ—Å—Ç –Ω–∞—á–∞–ª—Å—è
                if (exam.status === 'active' && !examStartTime) {
                    examStartTime = exam.startTime;
                    startExam();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ —Ç–µ—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω
                if (exam.status === 'active' && examStartTime) {
                    updateTimer(exam.timeLimit, exam.startTime);
                }

                // –ï—Å–ª–∏ —Ç–µ—Å—Ç –∑–∞–∫–æ–Ω—á–µ–Ω
                if (exam.status === 'finished') {
                    showLeaderboard();
                }
            });
        }

        // ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ò–ì–†–û–ö–û–í =====
        function updatePlayersList(players) {
            const list = document.getElementById('playersList');
            const count = document.getElementById('playerCount');
            
            if (!players) {
                list.innerHTML = '<span class="player-badge">üë§ –û–∂–∏–¥–∞–Ω–∏–µ...</span>';
                count.textContent = '0';
                return;
            }

            const playerArray = Object.keys(players);
            count.textContent = playerArray.length;

            list.innerHTML = playerArray.map(name => `
                <span class="player-badge">
                    üë§ ${name}
                </span>
            `).join('');
        }

        // ===== –ù–ê–ß–ê–õ–û –¢–ï–°–¢–ê =====
        function startExam() {
            waitingScreen.classList.add('hidden');
            taskScreen.classList.remove('hidden');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            if (timerInterval) clearInterval(timerInterval);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
            currentTaskIndex = 0;
            loadTask(0);
        }

        // ===== –¢–ê–ô–ú–ï–† =====
        function updateTimer(timeLimit, startTime) {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = Math.max(0, timeLimit - elapsed);
                
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                document.getElementById('taskTimer').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    showLeaderboard();
                }
            }, 1000);
        }

        // ===== –ó–ê–ì–†–£–ó–ö–ê –ó–ê–î–ê–ù–ò–Ø =====
        function loadTask(index) {
            const task = EXAM_DATA.tasks[index];
            if (!task) return;

            document.getElementById('taskCounter').textContent = `${index + 1}/${EXAM_DATA.totalTasks}`;
            
            const container = document.getElementById('taskContent');
            selectedOption = null;
            
            switch(task.type) {
                case 'formula':
                case 'prism':
                case 'hard':
                    loadChoiceTask(task, container);
                    break;
                    
                case 'calculation':
                case 'angle_calc':
                case 'critical':
                    loadCalculationTask(task, container);
                    break;
                    
                case 'flip_cards':
                    loadFlipCardsTask(task, container);
                    break;
                    
                case 'laser':
                    loadLaserTask(task, container);
                    break;
                    
                default:
                    loadChoiceTask(task, container);
            }
        }

        // ===== –ó–ê–î–ê–ù–ò–ï –° –í–´–ë–û–†–û–ú –û–¢–í–ï–¢–ê =====
        function loadChoiceTask(task, container) {
            let html = `
                <div class="task-title">${task.title}</div>
                <div class="task-description">${task.description}</div>
                ${task.image ? `<div style="font-size: 4rem; text-align: center; margin: 20px 0;">${task.image}</div>` : ''}
                <div class="options-grid">
            `;
            
            task.options.forEach((option, i) => {
                html += `
                    <div class="option-btn" onclick="selectOption(this, ${i})">
                        <span class="option-prefix">${String.fromCharCode(65 + i)}</span>
                        ${option.text}
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }

        // ===== –ó–ê–î–ê–ù–ò–ï –° –ß–ò–°–õ–û–í–´–ú –û–¢–í–ï–¢–û–ú =====
        function loadCalculationTask(task, container) {
            let html = `
                <div class="task-title">${task.title}</div>
                <div class="task-description">${task.description}</div>
                ${task.image ? `<div style="font-size: 4rem; text-align: center; margin: 20px 0;">${task.image}</div>` : ''}
                ${task.formula ? `<div style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 20px; margin: 20px 0; font-family: monospace; font-size: 1.2rem;">${task.formula}</div>` : ''}
                <input type="number" id="numberAnswer" class="number-input" placeholder="–í–≤–µ–¥–∏ —á–∏—Å–ª–æ" step="0.1">
            `;
            container.innerHTML = html;
        }

        // ===== –ü–ï–†–ï–í–ï–†–¢–´–®–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï) =====
        function loadFlipCardsTask(task, container) {
            // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç–æ—á–µ–∫
            let cards = [];
            task.pairs.forEach((pair, index) => {
                cards.push({
                    id: `term_${index}`,
                    pairId: index,
                    text: pair.term,
                    type: 'term'
                });
                cards.push({
                    id: `def_${index}`,
                    pairId: index,
                    text: pair.definition,
                    type: 'def'
                });
            });
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
            cards = cards.sort(() => Math.random() - 0.5);
            
            let html = `
                <div class="task-title">${task.title}</div>
                <div class="task-description">${task.description}</div>
                <div class="flip-grid" id="flipGrid">
            `;
            
            cards.forEach((card, index) => {
                html += `
                    <div class="flip-card" data-id="${card.id}" data-pair="${card.pairId}" data-type="${card.type}" data-index="${index}" onclick="flipCard(this)">
                        <div class="front">‚ùì</div>
                        <div class="back">${card.text}</div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            flippedCards = [];
            matchedPairs = 0;
        }

        // ===== –ü–ï–†–ï–í–û–†–û–¢ –ö–ê–†–¢–û–ß–ö–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) =====
        function flipCard(card) {
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∂–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if (card.classList.contains('matched') || card.classList.contains('flipped')) {
                return;
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
            card.classList.add('flipped');
            flippedCards.push(card);
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ 2 –∫–∞—Ä—Ç–æ—á–∫–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä—É
            if (flippedCards.length === 2) {
                const card1 = flippedCards[0];
                const card2 = flippedCards[1];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–±—Ä–∞–∑—É—é—Ç –ª–∏ –æ–Ω–∏ –ø–∞—Ä—É
                if (card1.dataset.pair === card2.dataset.pair) {
                    // –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
                    setTimeout(() => {
                        card1.classList.add('matched');
                        card2.classList.add('matched');
                        flippedCards = [];
                        matchedPairs++;
                        
                        // –ï—Å–ª–∏ –≤—Å–µ –ø–∞—Ä—ã –Ω–∞–π–¥–µ–Ω—ã
                        if (matchedPairs === 4) { // 4 –ø–∞—Ä—ã –≤ –∑–∞–¥–∞–Ω–∏–∏
                            document.getElementById('submitBtn').click();
                        }
                    }, 500);
                } else {
                    // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        flippedCards = [];
                    }, 800);
                }
            }
        }

        // ===== –õ–ê–ó–ï–† (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤) =====
        function loadLaserTask(task, container) {
            container.innerHTML = `
                <div class="task-title">${task.title}</div>
                <div class="task-description">${task.description}</div>
                <canvas id="laserCanvas" class="laser-canvas"></canvas>
                <div style="text-align: center; color: #94a3b8;">
                    üëÜ –¢–∞—â–∏ –ª—É—á –ø–∞–ª—å—Ü–µ–º
                </div>
            `;
            
            setTimeout(() => initLaser(task.params), 100);
        }

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –õ–ê–ó–ï–†–ê =====
        function initLaser(params) {
            const canvas = document.getElementById('laserCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.offsetWidth;
            const h = canvas.height = canvas.offsetHeight;
            
            let mouseX = w / 2;
            
            function draw() {
                ctx.clearRect(0, 0, w, h);
                
                // –†–∏—Å—É–µ–º –≥—Ä–∞–Ω–∏—Ü—É –≤–æ–¥–∞-–≤–æ–∑–¥—É—Ö
                ctx.beginPath();
                ctx.strokeStyle = '#a78bfa';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 10]);
                ctx.moveTo(0, h/2);
                ctx.lineTo(w, h/2);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // –†–∏—Å—É–µ–º —Ä—ã–±–∫—É
                ctx.font = '30px Arial';
                ctx.fillStyle = '#fbbf24';
                ctx.fillText('üêü', params.fishX * w / 100, params.fishY * h / 100);
                
                // –†–∏—Å—É–µ–º –ª–∞–∑–µ—Ä
                const angle = ((mouseX / w) * 90) * Math.PI / 180;
                
                ctx.beginPath();
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 3;
                ctx.moveTo(50, h/2);
                
                // –ü—Ä–µ–ª–æ–º–ª–µ–Ω–∏–µ
                const sinAlpha = Math.sin(angle);
                const sinBeta = sinAlpha * params.n1 / params.n2;
                
                if (sinBeta <= 1) {
                    const beta = Math.asin(sinBeta);
                    ctx.lineTo(50 + 100 * Math.cos(angle), h/2 - 50 * Math.sin(angle));
                    ctx.strokeStyle = '#ef4444';
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.strokeStyle = '#4ade80';
                    ctx.moveTo(50 + 100 * Math.cos(angle), h/2 - 50 * Math.sin(angle));
                    ctx.lineTo(50 + 100 * Math.cos(angle) + 150 * Math.cos(beta), h/2 - 50 * Math.sin(angle) + 150 * Math.sin(beta));
                    ctx.stroke();
                } else {
                    // –ü–æ–ª–Ω–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ
                    ctx.lineTo(50 + 150 * Math.cos(angle), h/2 - 150 * Math.sin(angle));
                    ctx.stroke();
                }
            }
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                mouseX = e.touches[0].clientX - rect.left;
                draw();
            });
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                draw();
            });
            
            draw();
        }

        // ===== –í–´–ë–û–† –û–ü–¶–ò–ò =====
        function selectOption(element, index) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedOption = index;
        }

        // ===== –û–¢–ü–†–ê–í–ö–ê –û–¢–í–ï–¢–ê =====
        function submitAnswer() {
            const task = EXAM_DATA.tasks[currentTaskIndex];
            let isCorrect = false;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
            if (task.type === 'flip_cards') {
                // –î–ª—è –ø–µ—Ä–µ–≤–µ—Ä—Ç—ã—à–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –ø–∞—Ä—ã –Ω–∞–π–¥–µ–Ω—ã
                isCorrect = (matchedPairs === 4);
            } else if (task.type === 'calculation' || task.type === 'angle_calc' || task.type === 'critical') {
                // –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                const answer = parseFloat(document.getElementById('numberAnswer')?.value);
                isCorrect = Math.abs(answer - task.correctAnswer) < 0.1;
            } else {
                // –î–ª—è –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞
                if (selectedOption === undefined) {
                    alert('–í—ã–±–µ—Ä–∏ –æ—Ç–≤–µ—Ç!');
                    return;
                }
                isCorrect = task.options[selectedOption].correct;
            }
            
            if (isCorrect) {
                playerScore += task.points;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                db.ref(`exams/${currentExamId}/players/${playerName}`).update({
                    score: playerScore,
                    progress: Math.round(((currentTaskIndex + 1) / EXAM_DATA.totalTasks) * 100),
                    currentTask: currentTaskIndex + 2
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                if (currentTaskIndex + 1 >= EXAM_DATA.totalTasks) {
                    showLeaderboard();
                } else {
                    submitBtn.style.display = 'none';
                    nextBtn.style.display = 'block';
                }
            } else {
                alert('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑');
            }
        }

        // ===== –°–õ–ï–î–£–Æ–©–ï–ï –ó–ê–î–ê–ù–ò–ï =====
        function nextTask() {
            submitBtn.style.display = 'block';
            nextBtn.style.display = 'none';
            currentTaskIndex++;
            loadTask(currentTaskIndex);
        }

        // ===== –ü–û–ö–ê–ó–ê–¢–¨ –õ–ò–î–ï–†–ë–û–†–î =====
        function showLeaderboard() {
            clearInterval(timerInterval);
            
            taskScreen.classList.add('hidden');
            leaderboardScreen.classList.remove('hidden');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
            db.ref(`exams/${currentExamId}/players`).once('value', (snapshot) => {
                const players = snapshot.val() || {};
                const sorted = Object.entries(players)
                    .sort((a, b) => b[1].score - a[1].score);
                
                // –ù–∞—Ö–æ–¥–∏–º –º–µ—Å—Ç–æ –∏–≥—Ä–æ–∫–∞
                let rank = 1;
                for (let [name, data] of sorted) {
                    if (name === playerName) break;
                    rank++;
                }
                
                document.getElementById('finalScore').textContent = `${playerScore} ‚≠ê`;
                document.getElementById('finalRank').textContent = `–¢–≤–æ—ë –º–µ—Å—Ç–æ: ${rank} –∏–∑ ${sorted.length}`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '<h3 style="margin-bottom: 15px;">üèÜ –õ–ò–î–ï–†–´</h3>';
                
                sorted.slice(0, 5).forEach(([name, data], i) => {
                    leaderboardList.innerHTML += `
                        <div class="rank-item">
                            <span class="rank-${i+1}">${i+1}. ${name}</span>
                            <span>${data.score} ‚≠ê</span>
                        </div>
                    `;
                });
            });
        }

        // ===== –í–´–•–û–î =====
        function exitExam() {
            location.reload();
        }

        // ===== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –§–û–ö–£–° –ù–ê –ö–û–î =====
        document.getElementById('examCode').addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').substring(0, 6);
        });
        
        document.getElementById('playerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('examCode').focus();
            }
        });
        
        document.getElementById('examCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinExam();
            }
        });
    </script>
</body>
</html>
