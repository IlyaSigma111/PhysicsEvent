<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë®‚Äçüè´ —É—á–∏—Ç–µ–ª—å ¬∑ —Ç–µ—Å—Ç 30 –≤–æ–ø—Ä–æ—Å–æ–≤</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(145deg, #1a0f05, #8b4513);
            font-family: system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .panel {
            background: rgba(20, 12, 5, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 25px;
            border: 2px solid #b45f1b;
        }

        h1 {
            color: #ffd89c;
            margin-bottom: 20px;
        }

        .btn {
            background: #b45f1b;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 5px;
        }

        .code-box {
            background: #1a0f05;
            border: 2px solid #b45f1b;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .code {
            font-size: 5rem;
            font-family: monospace;
            color: #ffd966;
            letter-spacing: 10px;
        }

        .timer {
            font-size: 4rem;
            color: #ffd966;
            text-align: center;
            font-family: monospace;
            margin: 20px 0;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .student-card {
            background: #1a0f05;
            border: 1px solid #b45f1b;
            border-radius: 20px;
            padding: 15px;
            margin: 10px 0;
            color: #ffd89c;
        }

        .progress-bar {
            height: 10px;
            background: #2a1a0a;
            border-radius: 10px;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #b45f1b;
            border-radius: 10px;
            width: 0%;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #b45f1b;
            color: #ffd89c;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="panel">
            <h1>üë®‚Äçüè´ —É—á–∏—Ç–µ–ª—å</h1>
            <button class="btn" onclick="createGame()">‚ûï —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç</button>

            <div id="gamePanel" class="hidden">
                <div class="code-box">
                    <div style="color: #b45f1b;">–∫–æ–¥ —Ç–µ—Å—Ç–∞</div>
                    <div class="code" id="gameCode">000000</div>
                </div>

                <div class="timer" id="timer">15:00</div>

                <div class="controls">
                    <button class="btn" onclick="startGame()">‚ñ∂ —Å—Ç–∞—Ä—Ç</button>
                    <button class="btn" onclick="endGame()">‚èπ —Ñ–∏–Ω–∏—à</button>
                </div>

                <h2>üë• —É—á–µ–Ω–∏–∫–∏</h2>
                <div id="studentsList"></div>
            </div>

            <div id="noGame" style="text-align: center; color: #b45f1b; padding: 40px;">
                üåÖ —Å–æ–∑–¥–∞–π —Ç–µ—Å—Ç —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
            </div>
        </div>

        <div class="panel">
            <h1>üèÜ –ª–∏–¥–µ—Ä—ã</h1>
            <div id="leaderboard"></div>
            <div style="margin-top: 20px; color: #ffd89c;" id="stats"></div>
        </div>
    </div>

    <script>
        let gameId = null;

        function createGame() {
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            gameId = `game_${code}`;

            db.ref(`games/${gameId}`).set({
                status: 'waiting',
                startTime: null,
                players: {}
            }).then(() => {
                document.getElementById('noGame').classList.add('hidden');
                document.getElementById('gamePanel').classList.remove('hidden');
                document.getElementById('gameCode').innerText = code;
                listenToGame();
            });
        }

        function listenToGame() {
            db.ref(`games/${gameId}`).on('value', (snap) => {
                const data = snap.val();
                if (!data) return;

                // –°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤
                if (data.players) {
                    let html = '';
                    for (let [name, player] of Object.entries(data.players)) {
                        const progress = player.progress || 0;
                        const percent = (progress / 30) * 100;
                        html += `
                            <div class="student-card">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>üë§ ${name}</span>
                                    <span>${progress}/30</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        `;
                    }
                    document.getElementById('studentsList').innerHTML = html || '<div style="color:#b45f1b;">–∂–¥—ë–º —É—á–µ–Ω–∏–∫–æ–≤...</div>';
                }

                // –õ–∏–¥–µ—Ä–±–æ—Ä–¥
                if (data.players) {
                    const sorted = Object.entries(data.players)
                        .filter(([_, p]) => p.score !== undefined)
                        .sort((a, b) => b[1].score - a[1].score)
                        .slice(0, 5);

                    let lbHtml = '';
                    sorted.forEach(([name, p], i) => {
                        lbHtml += `
                            <div class="leaderboard-item">
                                <span>${i+1}. ${name}</span>
                                <span>${p.score} ‚ú®</span>
                            </div>
                        `;
                    });
                    document.getElementById('leaderboard').innerHTML = lbHtml || '<div style="color:#b45f1b;">–ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>';

                    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    const total = Object.keys(data.players).length;
                    const completed = Object.values(data.players).filter(p => p.progress === 30).length;
                    document.getElementById('stats').innerHTML = `
                        <div>üë• –≤—Å–µ–≥–æ: ${total}</div>
                        <div>‚úÖ –∑–∞–≤–µ—Ä—à–∏–ª–∏: ${completed}</div>
                    `;
                }

                // –¢–∞–π–º–µ—Ä
                if (data.status === 'active' && data.startTime) {
                    updateTimer(data.startTime);
                }
            });
        }

        function updateTimer(startTime) {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const left = Math.max(0, 900 - elapsed);
                const m = Math.floor(left / 60);
                const s = left % 60;
                document.getElementById('timer').innerText = 
                    `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }, 1000);
        }

        function startGame() {
            db.ref(`games/${gameId}`).update({
                status: 'active',
                startTime: Date.now()
            });
        }

        function endGame() {
            db.ref(`games/${gameId}`).update({ status: 'finished' });
        }
    </script>
</body>
</html>
