<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë®‚Äçüè´ —É—á–∏—Ç–µ–ª—å ¬∑ —Ç–µ—Å—Ç 30 –≤–æ–ø—Ä–æ—Å–æ–≤</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(145deg, #1a0f05, #8b4513);
            font-family: system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .panel {
            background: rgba(20, 12, 5, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 25px;
            border: 2px solid #b45f1b;
        }

        h1 {
            color: #ffd89c;
            margin-bottom: 20px;
        }

        .btn {
            background: #b45f1b;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-danger {
            background: #b45f1b;
            border: 2px solid #ff6b6b;
        }

        .code-box {
            background: #1a0f05;
            border: 2px solid #b45f1b;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .code {
            font-size: 5rem;
            font-family: monospace;
            color: #ffd966;
            letter-spacing: 10px;
        }

        .timer {
            font-size: 4rem;
            color: #ffd966;
            text-align: center;
            font-family: monospace;
            margin: 20px 0;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .student-card {
            background: #1a0f05;
            border: 1px solid #b45f1b;
            border-radius: 20px;
            padding: 15px;
            margin: 10px 0;
            color: #ffd89c;
        }

        .progress-bar {
            height: 10px;
            background: #2a1a0a;
            border-radius: 10px;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #b45f1b;
            border-radius: 10px;
            width: 0%;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #b45f1b;
            color: #ffd89c;
            font-size: 1.1rem;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank-1 { color: gold; }
        .rank-2 { color: silver; }
        .rank-3 { color: #cd7f32; }

        .stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #b45f1b;
            color: #ffd89c;
        }

        .stats div {
            margin: 8px 0;
        }

        .hidden {
            display: none;
        }

        .empty {
            text-align: center;
            color: #b45f1b;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="panel">
            <h1>üë®‚Äçüè´ —É—á–∏—Ç–µ–ª—å</h1>
            <button class="btn" onclick="createGame()">‚ûï —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç</button>

            <div id="gamePanel" class="hidden">
                <div class="code-box">
                    <div style="color: #b45f1b;">–∫–æ–¥ —Ç–µ—Å—Ç–∞</div>
                    <div class="code" id="gameCode">000000</div>
                </div>

                <div class="timer" id="timer">15:00</div>

                <div class="controls">
                    <button class="btn" onclick="startGame()">‚ñ∂ —Å—Ç–∞—Ä—Ç</button>
                    <button class="btn btn-danger" onclick="finishGame()">‚èπ —Ñ–∏–Ω–∏—à</button>
                </div>

                <h2>üë• —É—á–µ–Ω–∏–∫–∏ (<span id="studentsCount">0</span>)</h2>
                <div id="studentsList"></div>
            </div>

            <div id="noGame" class="empty">
                üåÖ —Å–æ–∑–¥–∞–π —Ç–µ—Å—Ç —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ª–∏–¥–µ—Ä–±–æ—Ä–¥ -->
        <div class="panel">
            <h1>üèÜ –ª–∏–¥–µ—Ä–±–æ—Ä–¥</h1>
            <div id="leaderboard">
                <div class="empty">–ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>
            </div>
            
            <div class="stats" id="stats">
                <div>üë• –≤—Å–µ–≥–æ: <span id="totalCount">0</span></div>
                <div>‚úÖ –∑–∞–≤–µ—Ä—à–∏–ª–∏: <span id="completedCount">0</span></div>
                <div>üìä —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: <span id="avgScore">0</span></div>
            </div>
        </div>
    </div>

    <script>
        let gameId = null;
        let timerInterval = null;

        // ===== –°–û–ó–î–ê–¢–¨ –¢–ï–°–¢ =====
        function createGame() {
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            gameId = `game_${code}`;

            db.ref(`games/${gameId}`).set({
                status: 'waiting',
                startTime: null,
                timeLimit: 900, // 15 –º–∏–Ω—É—Ç
                players: {}
            }).then(() => {
                document.getElementById('noGame').classList.add('hidden');
                document.getElementById('gamePanel').classList.remove('hidden');
                document.getElementById('gameCode').innerText = code;
                listenToGame();
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–∞');
            });
        }

        // ===== –°–õ–£–®–ê–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø =====
        function listenToGame() {
            db.ref(`games/${gameId}`).on('value', (snap) => {
                const data = snap.val();
                if (!data) return;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤
                updateStudentsList(data.players);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–¥–µ—Ä–±–æ—Ä–¥
                updateLeaderboard(data.players);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
                if (data.status === 'active' && data.startTime) {
                    updateTimer(data.startTime, data.timeLimit);
                } else if (data.status === 'finished') {
                    if (timerInterval) clearInterval(timerInterval);
                    document.getElementById('timer').innerText = '00:00';
                }
            });
        }

        // ===== –û–ë–ù–û–í–ò–¢–¨ –°–ü–ò–°–û–ö –£–ß–ï–ù–ò–ö–û–í =====
        function updateStudentsList(players) {
            const list = document.getElementById('studentsList');
            const count = document.getElementById('studentsCount');
            
            if (!players || Object.keys(players).length === 0) {
                list.innerHTML = '<div style="color:#b45f1b;">–∂–¥—ë–º —É—á–µ–Ω–∏–∫–æ–≤...</div>';
                count.innerText = '0';
                return;
            }

            const playersArray = Object.entries(players);
            count.innerText = playersArray.length;

            list.innerHTML = playersArray.map(([name, player]) => {
                const progress = player.progress || 0;
                const percent = (progress / 30) * 100;
                const score = player.score || 0;
                
                return `
                    <div class="student-card">
                        <div style="display: flex; justify-content: space-between;">
                            <span>üë§ ${name}</span>
                            <span>${progress}/30 ¬∑ ${score} ‚ú®</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===== –û–ë–ù–û–í–ò–¢–¨ –õ–ò–î–ï–†–ë–û–†–î =====
        function updateLeaderboard(players) {
            if (!players || Object.keys(players).length === 0) {
                document.getElementById('leaderboard').innerHTML = '<div class="empty">–ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>';
                document.getElementById('totalCount').innerText = '0';
                document.getElementById('completedCount').innerText = '0';
                document.getElementById('avgScore').innerText = '0';
                return;
            }

            const playersArray = Object.entries(players);
            
            // –¢–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å –æ—á–∫–∏
            const withScores = playersArray.filter(([_, p]) => p.score !== undefined);
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ—á–∫–∞–º
            withScores.sort((a, b) => (b[1].score || 0) - (a[1].score || 0));

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const total = playersArray.length;
            const completed = playersArray.filter(([_, p]) => p.progress === 30).length;
            const avg = withScores.length > 0 
                ? Math.round(withScores.reduce((acc, [_, p]) => acc + (p.score || 0), 0) / withScores.length) 
                : 0;

            document.getElementById('totalCount').innerText = total;
            document.getElementById('completedCount').innerText = completed;
            document.getElementById('avgScore').innerText = avg;

            // –õ–∏–¥–µ—Ä–±–æ—Ä–¥ (—Ç–æ–ø-10)
            if (withScores.length === 0) {
                document.getElementById('leaderboard').innerHTML = '<div class="empty">–ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>';
                return;
            }

            let lbHtml = '';
            withScores.slice(0, 10).forEach(([name, player], index) => {
                const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                lbHtml += `
                    <div class="leaderboard-item">
                        <span class="${rankClass}">${index + 1}. ${name}</span>
                        <span>${player.score || 0} ‚ú®</span>
                    </div>
                `;
            });

            document.getElementById('leaderboard').innerHTML = lbHtml;
        }

        // ===== –û–ë–ù–û–í–ò–¢–¨ –¢–ê–ô–ú–ï–† =====
        function updateTimer(startTime, timeLimit) {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = Math.max(0, timeLimit - elapsed);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                
                document.getElementById('timer').innerText = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                // –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ–º
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    db.ref(`games/${gameId}`).update({ status: 'finished' });
                }
            }, 1000);
        }

        // ===== –°–¢–ê–†–¢ –¢–ï–°–¢–ê =====
        function startGame() {
            if (!gameId) return;
            
            db.ref(`games/${gameId}`).update({
                status: 'active',
                startTime: Date.now()
            }).then(() => {
                console.log('‚úÖ –¢–µ—Å—Ç –Ω–∞—á–∞—Ç');
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞');
            });
        }

        // ===== –§–ò–ù–ò–® –¢–ï–°–¢–ê (–î–û–°–†–û–ß–ù–û) =====
        function finishGame() {
            if (!gameId) return;
            
            if (!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç –¥–æ—Å—Ä–æ—á–Ω–æ? –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.')) {
                return;
            }

            db.ref(`games/${gameId}`).update({ 
                status: 'finished' 
            }).then(() => {
                console.log('‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω –¥–æ—Å—Ä–æ—á–Ω–æ');
                if (timerInterval) clearInterval(timerInterval);
                document.getElementById('timer').innerText = '00:00';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥
                db.ref(`games/${gameId}/players`).once('value', (snap) => {
                    updateLeaderboard(snap.val());
                });
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞');
            });
        }
    </script>
</body>
</html>
